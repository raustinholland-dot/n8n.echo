{
  "id": "RlnZGOaKU4ee7D6M",
  "name": "ECHOv4 - PostgreSQL_TESTING",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 1,
              "unit": "minutes"
            }
          ]
        },
        "simple": false,
        "filters": {
          "sender": "austin.holland@clearwatersecurity.com"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -896,
        256
      ],
      "name": "Gmail Trigger - Deal Inputs",
      "alwaysOutputData": false,
      "executeOnce": false,
      "credentials": {
        "gmailOAuth2": {
          "id": "KcxcROH9oa3L7IUB",
          "name": "Gmail ECHO"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Classify input type and extract content\nconst items = $input.all();\nconst results = [];\n\n// Helper: Normalize account name to slug format\nfunction normalizeToSlug(text) {\n  if (!text) return null;\n  return text\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, '-')  // Replace non-alphanumeric with dashes\n    .replace(/^-+|-+$/g, '')      // Trim leading/trailing dashes\n    .replace(/-+/g, '-');          // Collapse multiple dashes\n}\n\nfor (const item of items) {\n  // Check if input is from webhook (MCP) or Gmail\n  const isWebhook = item.json.body !== undefined;\n  \n  let content, subject, input_type, deal_slug, salesforce_opportunity_id, date, source_filename;\n  let opportunity_name, account_name, close_date, trigger_type;\n  \n  if (isWebhook) {\n    // MCP/Webhook input - convert camelCase to snake_case\n    const body = item.json.body;\n    // Generate content from webhook fields if not provided\n    if (body.content) {\n      content = body.content;\n    } else {\n      // Build descriptive content from available fields\n      const parts = [];\n      if (trigger_type && trigger_type !== 'deal_intake') {\n        parts.push(`${trigger_type}`);\n      } else {\n        parts.push('New deal opportunity');\n      }\n      \n      if (opportunity_name) {\n        parts.push(`\"${opportunity_name}\"`);\n      }\n      \n      if (account_name) {\n        parts.push(`at ${account_name}`);\n      }\n      \n      if (close_date) {\n        parts.push(`(expected close: ${close_date})`);\n      }\n      \n      content = parts.join(' ') + '. This is initial deal intake with minimal information.';\n    }\n    input_type = body.input_type || body.inputType || 'call_transcript';\n    opportunity_name = body.opportunity_name || body.opportunityName || null;\n    account_name = body.account_name || body.accountName || null;\n    close_date = body.close_date || body.closeDate || null;\n    trigger_type = body.trigger_type || body.triggerType || 'deal_intake';\n    salesforce_opportunity_id = body.salesforce_opportunity_id || body.salesforceOpportunityId || null;\n    date = body.date || new Date().toISOString().split('T')[0];\n    source_filename = body.source_filename || body.sourceFilename || 'mcp-input';\n    \n    // Slug generation logic:\n    // 1. Use provided slug if exists\n    // 2. Normalize account_name if provided\n    // 3. Fall back to date-based slug\n    if (body.deal_slug || body.dealSlug) {\n      deal_slug = body.deal_slug || body.dealSlug;\n    } else if (account_name) {\n      const accountSlug = normalizeToSlug(account_name);\n      deal_slug = `${accountSlug}-${date}`;\n    } else {\n      deal_slug = `deal-${date}`;\n    }\n    \n  } else {\n    // Gmail input\n    subject = item.json.subject || '';\n    const text = item.json.text || item.json.textPlain || '';\n    content = text;\n    \n    // Check for X-ECHO-Deal-Slug header first (most reliable)\n    const headers = item.json.headers || {};\n    const echoSlugHeader = headers['x-echo-deal-slug'] || headers['X-ECHO-Deal-Slug'] || headers['X-Echo-Deal-Slug'];\n    \n    if (echoSlugHeader) {\n      deal_slug = echoSlugHeader;\n    } else {\n      // Strip email prefixes (Re:, Fwd:, FW:, etc.) then extract account name\n      const cleanSubject = subject.replace(/^(Re:|Fwd:|FW:|RE:|FWD:)\\s*/gi, '').trim();\n      const subjectMatch = cleanSubject.match(/^([^-]+)/);\n      if (subjectMatch) {\n        const extractedAccount = subjectMatch[1].trim();\n        account_name = extractedAccount;\n        deal_slug = `${normalizeToSlug(extractedAccount)}-${new Date().toISOString().split('T')[0]}`;\n      } else {\n        deal_slug = `deal-${new Date().toISOString().split('T')[0]}`;\n      }\n    }\n    \n    // Determine input type\n    input_type = 'email';\n    if (subject.toLowerCase().includes('transcript')) {\n      input_type = 'call_transcript';\n    } else if (subject.toLowerCase().includes('notes')) {\n      input_type = 'call_notes';\n    }\n    \n    salesforce_opportunity_id = null;\n    date = new Date().toISOString().split('T')[0];\n    source_filename = `email-${item.json.id || 'unknown'}`;\n    opportunity_name = null;\n    close_date = null;\n    trigger_type = 'email_trigger';\n  }\n  \n  results.push({\n    json: {\n      content: content,\n      subject: subject,\n      input_type: input_type,\n      deal_slug: deal_slug,\n      salesforce_opportunity_id: salesforce_opportunity_id,\n      date: date,\n      source_filename: source_filename,\n      opportunity_name: opportunity_name,\n      account_name: account_name,\n      close_date: close_date,\n      trigger_type: trigger_type\n    }\n  });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        160
      ],
      "name": "Input Classifier"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM deals \nWHERE salesforce_opportunity_id = '{{ $json.salesforce_opportunity_id }}'\n   OR deal_slug = '{{ $json.deal_slug }}'\n   OR (account_name IS NOT NULL \n       AND account_name ILIKE '{{ $json.account_name }}%')\nORDER BY \n  CASE \n    WHEN deal_slug = '{{ $json.deal_slug }}' THEN 1\n    WHEN salesforce_opportunity_id = '{{ $json.salesforce_opportunity_id }}' THEN 2\n    ELSE 3\n  END,\n  updated_at DESC\nLIMIT 1",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -464,
        160
      ],
      "name": "Load Deal Memory",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      },
      "continueOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Get input data using correct n8n syntax\nconst inputData = $('Input Classifier').item.json;\n\n// Check what we got from Load Deal Memory\nconst dealData = items?.[0]?.json;\nconst idValue = dealData?.id;\n\n// Check for valid deal - id must be a positive number\nconst hasValidDeal = typeof idValue === 'number' && idValue > 0;\n\nif (!hasValidDeal) {\n  // No valid deal\n  return [{ \n    json: { \n      _noDealsFound: true,\n      _contextSource: 'new_opportunity',\n      deal_slug: inputData.deal_slug,\n      opportunity_name: inputData.opportunity_name,\n      account_name: inputData.account_name,\n      close_date: inputData.close_date,\n      salesforce_opportunity_id: inputData.salesforce_opportunity_id,\n      trigger_type: inputData.trigger_type,\n      content: inputData.content,\n      input_type: inputData.input_type\n    }\n  }];\n}\n\n// Deal found\nreturn [{ \n  json: {\n    ...dealData,\n    _noDealsFound: false,\n    _contextSource: 'existing_deal',\n    content: inputData.content\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        32
      ],
      "name": "Validate Deal Memory",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Format outputs from ECHO passes for PostgreSQL and email\nconst agent3 = $('ECHO Pass 3 - Artifacts').item.json;\nconst agent2 = $('ECHO Pass 2 - Scoring').item.json;\nconst input = $('Input Classifier').item.json;\nconst dealContext = $('Merge Deal Context').item.json;\n\nif (!agent3 || !input) {\n  throw new Error('Missing required data from ECHO Pass 3 or Input Classifier');\n}\n\nfunction esc(val) {\n  if (val === null || val === undefined || val === '') return 'NULL';\n  return \"'\" + String(val).replace(/'/g, \"''\") + \"'\";\n}\nfunction escStr(val) {\n  if (val === null || val === undefined) return 'NULL';\n  return \"'\" + String(val).replace(/'/g, \"''\") + \"'\";\n}\nfunction escNum(val) {\n  const n = Number(val);\n  return isNaN(n) ? '0' : String(n);\n}\n\nfunction unwrap(node) {\n  const raw = node.output !== undefined ? node.output : node;\n  if (typeof raw === 'string') {\n    try {\n      const cleaned = raw.replace(/^```json\\s*/i, '').replace(/^```\\s*/i, '').replace(/```\\s*$/i, '').trim();\n      return JSON.parse(cleaned);\n    } catch(e) { return {}; }\n  }\n  return raw;\n}\n\nfunction extractStageCode(casStr) {\n  if (!casStr) return '1A';\n  const s = String(casStr);\n  const match = s.match(/^([1-5][AB])/i);\n  if (match) return match[1].toUpperCase();\n  const sl = s.toLowerCase();\n  if (sl.includes('close') || sl.includes('won') || sl.includes('lost')) return '5A';\n  if (sl.includes('negot') || sl.includes('contract') || sl.includes('msa') || sl.includes('sow')) return '4A';\n  if (sl.includes('prov') || sl.includes('valid') || sl.includes('proposal') || sl.includes('demo')) return '3A';\n  if (sl.includes('qualif') || sl.includes('engaged') || sl.includes('discover')) return '2A';\n  return '1A';\n}\n\n// Parse Pass 3 output (narratives + salesforce fields except scores)\nconst data3 = unwrap(agent3);\nconst sf = data3.salesforce || {};\nconst narr = data3.narratives || {};\n\n// Parse Pass 2 output (authoritative scores)\nconst data2 = unwrap(agent2);\nconst scores = data2.scores || {};\n\n// Scores come from Pass 2 \u2014 not Pass 3\nconst pain_score = Number(scores.pain?.score) || 0;\nconst pain_evidence = scores.pain?.evidence_description || sf.pain_evidence || '';\nconst power_score = Number(scores.power?.score) || 0;\nconst power_evidence = scores.power?.evidence_description || sf.power_evidence || '';\nconst vision_score = Number(scores.vision?.score) || 0;\nconst vision_evidence = scores.vision?.evidence_description || sf.vision_evidence || '';\nconst value_score = Number(scores.value?.score) || 0;\nconst value_evidence = scores.value?.evidence_description || sf.value_evidence || '';\nconst change_score = Number(scores.change?.score) || 0;\nconst change_evidence = scores.change?.evidence_description || sf.change_evidence || '';\nconst control_score = Number(scores.control?.score) || 0;\nconst control_evidence = scores.control?.evidence_description || sf.control_evidence || '';\nconst p2v2c2_total = pain_score + power_score + vision_score + value_score + change_score + control_score;\n\n// Salesforce fields from Pass 3\nconst close_date = sf.close_date || null;\nconst stage = sf.stage || '';\nconst cas = sf.cas || '';\nconst forecast_category = sf.forecast_category || '';\nconst salesforce_block_1_dap = sf.salesforce_block_1_dap || '';\nconst risks = sf.risks || '';\nconst next_step = sf.next_step || '';\n\n// Narratives from Pass 3\nconst call_summary = narr.call_summary || '';\nconst highlights = narr.highlights || '';\nconst action_items = narr.action_items || '';\nconst p2v2c2_scoring = narr.p2v2c2_scoring || '';\nconst internal_actions = narr.internal_actions || '';\nconst services_narrative = narr.services_narrative || '';\nconst general_narrative = narr.general_narrative || '';\nconst anecdotes = narr.anecdotes || '';\nconst internal_team_update = narr.internal_team_update || '';\nconst pe_firm = narr.pe_firm || '';\nconst pe_sponsor_involvement = narr.pe_sponsor_involvement || '';\nconst pe_sponsor_score = Number(narr.pe_sponsor_score || data2.pe_sponsor_score) || 0;\nconst pe_sponsor_rationale = narr.pe_sponsor_rationale || data2.pe_sponsor_rationale || '';\n\nconst deal_slug = input.deal_slug || '';\nconst salesforce_opportunity_id = dealContext?.salesforce_opportunity_id || input.salesforce_opportunity_id || null;\nconst opportunity_name = input.opportunity_name || dealContext?.opportunity_name || '';\nconst account_name = input.account_name || dealContext?.account_name || '';\n\nconst stage_code = extractStageCode(cas);\nconst cas_confidence = 'medium';\nconst event_type = input.input_type || '';\nconst event_date = input.date || new Date().toISOString().split('T')[0];\nconst summary_str = `Processed ${input.input_type} - CAS: ${cas || 'N/A'}`;\nconst link_or_ref = input.source_filename || '';\nconst raw_content = (input.content || '').substring(0, 5000);\n\nconst insertDealSQL = `INSERT INTO deals (\n  deal_slug, salesforce_opportunity_id, outputs_version,\n  opportunity_name, account_name, stage, cas_current, cas_next, cas_confidence,\n  pain_score, power_score, vision_score, value_score, change_score, control_score,\n  pe_firm, pe_sponsor_involvement, pe_sponsor_score\n) VALUES (\n  ${esc(deal_slug)}, ${esc(salesforce_opportunity_id)}, 'v4',\n  ${escStr(opportunity_name)}, ${escStr(account_name)}, ${escStr(stage_code)},\n  ${escStr(cas)}, ${escStr('')}, ${escStr(cas_confidence)},\n  ${escNum(pain_score)}, ${escNum(power_score)}, ${escNum(vision_score)},\n  ${escNum(value_score)}, ${escNum(change_score)}, ${escNum(control_score)},\n  ${esc(pe_firm)}, ${esc(pe_sponsor_involvement)}, ${escNum(pe_sponsor_score)}\n)\nON CONFLICT (deal_slug) DO UPDATE SET\n  salesforce_opportunity_id = EXCLUDED.salesforce_opportunity_id,\n  outputs_version = EXCLUDED.outputs_version,\n  opportunity_name = EXCLUDED.opportunity_name,\n  account_name = EXCLUDED.account_name,\n  stage = EXCLUDED.stage,\n  cas_current = EXCLUDED.cas_current,\n  cas_confidence = EXCLUDED.cas_confidence,\n  pain_score = EXCLUDED.pain_score,\n  power_score = EXCLUDED.power_score,\n  vision_score = EXCLUDED.vision_score,\n  value_score = EXCLUDED.value_score,\n  change_score = EXCLUDED.change_score,\n  control_score = EXCLUDED.control_score,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING id`;\n\nconst updateDealSQL = `UPDATE deals SET\n  salesforce_opportunity_id = ${esc(salesforce_opportunity_id)},\n  outputs_version = 'v4',\n  opportunity_name = ${escStr(opportunity_name)},\n  account_name = ${escStr(account_name)},\n  stage = ${escStr(stage_code)},\n  cas_current = ${escStr(cas)},\n  cas_confidence = ${escStr(cas_confidence)},\n  close_date = ${close_date ? escStr(close_date) : 'NULL'},\n  pain_score = ${escNum(pain_score)},\n  power_score = ${escNum(power_score)},\n  vision_score = ${escNum(vision_score)},\n  value_score = ${escNum(value_score)},\n  change_score = ${escNum(change_score)},\n  control_score = ${escNum(control_score)},\n  pe_firm = ${esc(pe_firm)},\n  pe_sponsor_involvement = ${esc(pe_sponsor_involvement)},\n  pe_sponsor_score = ${escNum(pe_sponsor_score)},\n  updated_at = CURRENT_TIMESTAMP\nWHERE deal_slug = ${esc(deal_slug)}\nRETURNING *`;\n\nconst saveArtifactsSQL = `INSERT INTO artifacts (\n  deal_id,\n  salesforce_block_1_dap,\n  salesforce_pain_description, salesforce_power_description,\n  salesforce_vision_description, salesforce_value_description,\n  salesforce_change_description, salesforce_control_description,\n  approved\n) VALUES (\n  (SELECT id FROM deals WHERE deal_slug = ${esc(deal_slug)}),\n  ${esc(salesforce_block_1_dap)},\n  ${esc(pain_evidence)}, ${esc(power_evidence)},\n  ${esc(vision_evidence)}, ${esc(value_evidence)},\n  ${esc(change_evidence)}, ${esc(control_evidence)},\n  false\n)\nRETURNING id`;\n\nconst saveEvidenceSQL = `INSERT INTO p2v2c2_evidence (\n  deal_id, pain_score, pain_evidence, power_score, power_evidence,\n  vision_score, vision_evidence, value_score, value_evidence,\n  change_score, change_evidence, control_score, control_evidence, p2v2c2_total\n) VALUES (\n  (SELECT id FROM deals WHERE deal_slug = ${esc(deal_slug)}),\n  ${escNum(pain_score)}, ${esc(pain_evidence)},\n  ${escNum(power_score)}, ${esc(power_evidence)},\n  ${escNum(vision_score)}, ${esc(vision_evidence)},\n  ${escNum(value_score)}, ${esc(value_evidence)},\n  ${escNum(change_score)}, ${esc(change_evidence)},\n  ${escNum(control_score)}, ${esc(control_evidence)},\n  ${escNum(p2v2c2_total)}\n)\nRETURNING id`;\n\nconst saveHistorySQL = `INSERT INTO deal_history (\n  deal_id, event_type, event_source, event_date, summary,\n  link_or_ref, raw_content, cas_at_time, p2v2c2_total_at_time\n) VALUES (\n  (SELECT id FROM deals WHERE deal_slug = ${esc(deal_slug)}),\n  ${escStr(event_type)}, ${esc('')}, ${escStr(event_date)}::date,\n  ${escStr(summary_str)}, ${esc(link_or_ref)}, ${escStr(raw_content)},\n  ${escStr(cas)}, ${escNum(p2v2c2_total)}\n)\nRETURNING id`;\n\nconst deal = {\n  deal_slug, salesforce_opportunity_id, outputs_version: 'v4',\n  opportunity_name, account_name, stage: stage_code,\n  cas_current: cas, cas_next: '', cas_confidence, close_date,\n  pain_score, power_score, vision_score, value_score, change_score, control_score\n};\n\nreturn [{\n  json: {\n    deal,\n    _contextSource: dealContext?._contextSource || 'unknown',\n    insertDealSQL, updateDealSQL, saveArtifactsSQL, saveEvidenceSQL, saveHistorySQL,\n    close_date, stage, cas, forecast_category,\n    salesforce_block_1_dap, risks, next_step,\n    pain_score, pain_evidence,\n    power_score, power_evidence,\n    vision_score, vision_evidence,\n    value_score, value_evidence,\n    change_score, change_evidence,\n    control_score, control_evidence,\n    p2v2c2_total,\n    pe_firm, pe_sponsor_involvement, pe_sponsor_score, pe_sponsor_rationale, pe_sponsor_score,\n    call_summary, highlights, action_items, p2v2c2_scoring,\n    internal_actions, services_narrative, general_narrative,\n    anecdotes, internal_team_update\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1424,
        64
      ],
      "name": "Format for PostgreSQL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:5679/receive",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"execution_id\": \"{{ $execution.id }}\"\n}",
        "options": {
          "timeout": 5000,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        800,
        280
      ],
      "name": "Open Review Portal"
    },
    {
      "parameters": {
        "resume": "form",
        "formTitle": "Review & Edit Deal Artifacts",
        "formDescription": "Review and edit AI-generated artifacts before saving. Leave any field blank to keep the AI original. Check the Review Required email for the pre-filled content to copy in.",
        "formFields": {
          "values": [
            {
              "fieldLabel": "close_date",
              "fieldType": "text",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.close_date }}"
            },
            {
              "fieldLabel": "stage",
              "fieldType": "text",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.stage }}"
            },
            {
              "fieldLabel": "cas",
              "fieldType": "text",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.cas }}"
            },
            {
              "fieldLabel": "forecast_category",
              "fieldType": "text",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.forecast_category }}"
            },
            {
              "fieldLabel": "salesforce_block_1_dap",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.salesforce_block_1_dap }}"
            },
            {
              "fieldLabel": "risks",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.risks }}"
            },
            {
              "fieldLabel": "next_step",
              "fieldType": "text",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.next_step }}"
            },
            {
              "fieldLabel": "pain_score",
              "fieldType": "number",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.pain_score }}"
            },
            {
              "fieldLabel": "pain_evidence",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.pain_evidence }}"
            },
            {
              "fieldLabel": "power_score",
              "fieldType": "number",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.power_score }}"
            },
            {
              "fieldLabel": "power_evidence",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.power_evidence }}"
            },
            {
              "fieldLabel": "vision_score",
              "fieldType": "number",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.vision_score }}"
            },
            {
              "fieldLabel": "vision_evidence",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.vision_evidence }}"
            },
            {
              "fieldLabel": "value_score",
              "fieldType": "number",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.value_score }}"
            },
            {
              "fieldLabel": "value_evidence",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.value_evidence }}"
            },
            {
              "fieldLabel": "change_score",
              "fieldType": "number",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.change_score }}"
            },
            {
              "fieldLabel": "change_evidence",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.change_evidence }}"
            },
            {
              "fieldLabel": "control_score",
              "fieldType": "number",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.control_score }}"
            },
            {
              "fieldLabel": "control_evidence",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.control_evidence }}"
            },
            {
              "fieldLabel": "call_summary",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.call_summary }}"
            },
            {
              "fieldLabel": "highlights",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.highlights }}"
            },
            {
              "fieldLabel": "action_items",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.action_items }}"
            },
            {
              "fieldLabel": "p2v2c2_scoring",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.p2v2c2_scoring }}"
            },
            {
              "fieldLabel": "internal_actions",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.internal_actions }}"
            },
            {
              "fieldLabel": "services_narrative",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.services_narrative }}"
            },
            {
              "fieldLabel": "general_narrative",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.general_narrative }}"
            },
            {
              "fieldLabel": "anecdotes",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.anecdotes }}"
            },
            {
              "fieldLabel": "internal_team_update",
              "fieldType": "textarea",
              "requiredField": false,
              "defaultValue": "={{ $('Format for PostgreSQL').item.json.internal_team_update }}"
            }
          ]
        },
        "responseMode": "onReceived",
        "options": {
          "responseText": "Artifacts saved. Check your email for the final output."
        }
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1000,
        64
      ],
      "name": "Wait for Review (Editing Portal)",
      "webhookId": "echo-artifact-review"
    },
    {
      "parameters": {
        "jsCode": "// Merge original AI outputs with edits from the review form\nconst orig = $('Format for PostgreSQL').item.json;\nconst form = $input.item.json;\n\nfunction esc(val) {\n  if (val === null || val === undefined || val === '') return 'NULL';\n  return \"'\" + String(val).replace(/'/g, \"''\") + \"'\";\n}\nfunction escStr(val) {\n  if (val === null || val === undefined) return 'NULL';\n  return \"'\" + String(val).replace(/'/g, \"''\") + \"'\";\n}\nfunction escNum(val) {\n  const n = Number(val);\n  return isNaN(n) ? '0' : String(n);\n}\nfunction extractStageCode(casStr) {\n  if (!casStr) return '1A';\n  const s = String(casStr);\n  const match = s.match(/^([1-5][AB])/i);\n  if (match) return match[1].toUpperCase();\n  const sl = s.toLowerCase();\n  if (sl.includes('close') || sl.includes('won') || sl.includes('lost')) return '5A';\n  if (sl.includes('negot') || sl.includes('contract') || sl.includes('msa') || sl.includes('sow')) return '4A';\n  if (sl.includes('prov') || sl.includes('valid') || sl.includes('proposal') || sl.includes('demo')) return '3A';\n  if (sl.includes('qualif') || sl.includes('engaged') || sl.includes('discover')) return '2A';\n  return '1A';\n}\n\nfunction edited(formVal, origVal) {\n  const f = (formVal || '').trim();\n  return f.length > 0 ? f : (origVal || '');\n}\nfunction editedNum(formVal, origVal) {\n  const f = String(formVal || '').trim();\n  const n = Number(f);\n  return (!isNaN(n) && f.length > 0) ? n : origVal;\n}\n\n// Salesforce standalone\nconst close_date = edited(form['close_date'], orig.close_date);\nconst stage = edited(form['stage'], orig.stage);\nconst cas = edited(form['cas'], orig.cas);\nconst forecast_category = edited(form['forecast_category'], orig.forecast_category);\nconst salesforce_block_1_dap = edited(form['salesforce_block_1_dap'], orig.salesforce_block_1_dap);\nconst risks = edited(form['risks'], orig.risks);\nconst next_step = edited(form['next_step'], orig.next_step);\n\n// P2V2C2\nconst pain_score = editedNum(form['pain_score'], orig.pain_score);\nconst pain_evidence = edited(form['pain_evidence'], orig.pain_evidence);\nconst power_score = editedNum(form['power_score'], orig.power_score);\nconst power_evidence = edited(form['power_evidence'], orig.power_evidence);\nconst vision_score = editedNum(form['vision_score'], orig.vision_score);\nconst vision_evidence = edited(form['vision_evidence'], orig.vision_evidence);\nconst value_score = editedNum(form['value_score'], orig.value_score);\nconst value_evidence = edited(form['value_evidence'], orig.value_evidence);\nconst change_score = editedNum(form['change_score'], orig.change_score);\nconst change_evidence = edited(form['change_evidence'], orig.change_evidence);\nconst control_score = editedNum(form['control_score'], orig.control_score);\nconst control_evidence = edited(form['control_evidence'], orig.control_evidence);\nconst p2v2c2_total = pain_score + power_score + vision_score + value_score + change_score + control_score;\n\n// Narratives\nconst call_summary = edited(form['call_summary'], orig.call_summary);\nconst highlights = edited(form['highlights'], orig.highlights);\nconst action_items = edited(form['action_items'], orig.action_items);\nconst p2v2c2_scoring = edited(form['p2v2c2_scoring'], orig.p2v2c2_scoring);\nconst internal_actions = edited(form['internal_actions'], orig.internal_actions);\nconst services_narrative = edited(form['services_narrative'], orig.services_narrative);\nconst general_narrative = edited(form['general_narrative'], orig.general_narrative);\nconst anecdotes = edited(form['anecdotes'], orig.anecdotes);\nconst internal_team_update = edited(form['internal_team_update'], orig.internal_team_update);\n\nif (!orig || !orig.deal) throw new Error('Merge Edited Artifacts: orig.deal is missing. Format for PostgreSQL may have failed.');\nconst deal_slug = orig.deal.deal_slug;\nconst salesforce_opportunity_id = orig.deal.salesforce_opportunity_id || null;\nconst opportunity_name = orig.deal.opportunity_name || '';\nconst account_name = orig.deal.account_name || '';\nconst stage_code = extractStageCode(cas);\nconst cas_confidence = orig.deal.cas_confidence || 'medium';\nconst _contextSource = orig._contextSource || 'unknown';\n\n// Re-build input fields needed for evidence/history SQL\nconst input = $('Input Classifier').item.json;\nconst event_type = input.input_type || '';\nconst event_date = input.date || new Date().toISOString().split('T')[0];\nconst summary_str = `Processed ${input.input_type} - CAS: ${cas || 'N/A'}`;\nconst link_or_ref = input.source_filename || '';\nconst raw_content = (input.content || '').substring(0, 5000);\n\nconst insertDealSQL = `INSERT INTO deals (\n  deal_slug, salesforce_opportunity_id, outputs_version,\n  opportunity_name, account_name, stage, cas_current, cas_next, cas_confidence,\n  pain_score, power_score, vision_score, value_score, change_score, control_score\n) VALUES (\n  ${esc(deal_slug)}, ${esc(salesforce_opportunity_id)}, 'v4',\n  ${escStr(opportunity_name)}, ${escStr(account_name)}, ${escStr(stage_code)},\n  ${escStr(cas)}, ${escStr('')}, ${escStr(cas_confidence)},\n  ${escNum(pain_score)}, ${escNum(power_score)}, ${escNum(vision_score)},\n  ${escNum(value_score)}, ${escNum(change_score)}, ${escNum(control_score)}\n)\nON CONFLICT (deal_slug) DO UPDATE SET\n  salesforce_opportunity_id = EXCLUDED.salesforce_opportunity_id,\n  outputs_version = EXCLUDED.outputs_version,\n  opportunity_name = EXCLUDED.opportunity_name,\n  account_name = EXCLUDED.account_name,\n  stage = EXCLUDED.stage,\n  cas_current = EXCLUDED.cas_current,\n  cas_confidence = EXCLUDED.cas_confidence,\n  pain_score = EXCLUDED.pain_score,\n  power_score = EXCLUDED.power_score,\n  vision_score = EXCLUDED.vision_score,\n  value_score = EXCLUDED.value_score,\n  change_score = EXCLUDED.change_score,\n  control_score = EXCLUDED.control_score,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING id`;\n\nconst updateDealSQL = `UPDATE deals SET\n  salesforce_opportunity_id = ${esc(salesforce_opportunity_id)},\n  outputs_version = 'v4',\n  opportunity_name = ${escStr(opportunity_name)},\n  account_name = ${escStr(account_name)},\n  stage = ${escStr(stage_code)},\n  cas_current = ${escStr(cas)},\n  cas_confidence = ${escStr(cas_confidence)},\n  close_date = ${close_date ? escStr(close_date) : 'NULL'},\n  pain_score = ${escNum(pain_score)},\n  power_score = ${escNum(power_score)},\n  vision_score = ${escNum(vision_score)},\n  value_score = ${escNum(value_score)},\n  change_score = ${escNum(change_score)},\n  control_score = ${escNum(control_score)},\n  updated_at = CURRENT_TIMESTAMP\nWHERE deal_slug = ${esc(deal_slug)}\nRETURNING *`;\n\nconst saveArtifactsSQL = `INSERT INTO artifacts (\n  deal_id,\n  salesforce_block_1_dap,\n  salesforce_pain_description, salesforce_power_description,\n  salesforce_vision_description, salesforce_value_description,\n  salesforce_change_description, salesforce_control_description,\n  approved\n) VALUES (\n  (SELECT id FROM deals WHERE deal_slug = ${esc(deal_slug)}),\n  ${esc(salesforce_block_1_dap)},\n  ${esc(pain_evidence)}, ${esc(power_evidence)},\n  ${esc(vision_evidence)}, ${esc(value_evidence)},\n  ${esc(change_evidence)}, ${esc(control_evidence)},\n  false\n)\nRETURNING id`;\n\nconst saveEvidenceSQL = `INSERT INTO p2v2c2_evidence (\n  deal_id, pain_score, pain_evidence, power_score, power_evidence,\n  vision_score, vision_evidence, value_score, value_evidence,\n  change_score, change_evidence, control_score, control_evidence, p2v2c2_total\n) VALUES (\n  (SELECT id FROM deals WHERE deal_slug = ${esc(deal_slug)}),\n  ${escNum(pain_score)}, ${esc(pain_evidence)},\n  ${escNum(power_score)}, ${esc(power_evidence)},\n  ${escNum(vision_score)}, ${esc(vision_evidence)},\n  ${escNum(value_score)}, ${esc(value_evidence)},\n  ${escNum(change_score)}, ${esc(change_evidence)},\n  ${escNum(control_score)}, ${esc(control_evidence)},\n  ${escNum(p2v2c2_total)}\n)\nRETURNING id`;\n\nconst saveHistorySQL = `INSERT INTO deal_history (\n  deal_id, event_type, event_source, event_date, summary,\n  link_or_ref, raw_content, cas_at_time, p2v2c2_total_at_time\n) VALUES (\n  (SELECT id FROM deals WHERE deal_slug = ${esc(deal_slug)}),\n  ${escStr(event_type)}, ${esc('')}, ${escStr(event_date)}::date,\n  ${escStr(summary_str)}, ${esc(link_or_ref)}, ${escStr(raw_content)},\n  ${escStr(cas)}, ${escNum(p2v2c2_total)}\n)\nRETURNING id`;\n\nreturn [{\n  json: {\n    deal: orig.deal,\n    _contextSource,\n    insertDealSQL, updateDealSQL, saveArtifactsSQL, saveEvidenceSQL, saveHistorySQL,\n    close_date, stage, cas, forecast_category,\n    salesforce_block_1_dap, risks, next_step,\n    pain_score, pain_evidence,\n    power_score, power_evidence,\n    vision_score, vision_evidence,\n    value_score, value_evidence,\n    change_score, change_evidence,\n    control_score, control_evidence,\n    p2v2c2_total,\n    call_summary, highlights, action_items, p2v2c2_scoring,\n    internal_actions, services_narrative, general_narrative,\n    anecdotes, internal_team_update\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        64
      ],
      "name": "Merge Edited Artifacts"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "check-new-opp-id",
              "leftValue": "={{ $('Format for PostgreSQL').item.json._contextSource?.toLowerCase().trim() }}",
              "operator": {
                "type": "string",
                "operation": "contains",
                "singleValue": "new"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1120,
        64
      ],
      "name": "Check if New Deal"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('Format for PostgreSQL').item.json.insertDealSQL }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1280,
        -32
      ],
      "name": "Insert New Deal",
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('Format for PostgreSQL').item.json.updateDealSQL }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1280,
        160
      ],
      "name": "Update Existing Deal",
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('Format for PostgreSQL').item.json.saveArtifactsSQL }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1440,
        64
      ],
      "name": "Save Artifacts",
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT 1",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1440,
        208
      ],
      "name": "Save Artifact Feedback",
      "continueOnFail": true,
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('Format for PostgreSQL').item.json.saveEvidenceSQL }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1584,
        64
      ],
      "name": "Save P2V2C2 Evidence",
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $('Format for PostgreSQL').item.json.saveHistorySQL }}",
        "options": {
          "queryBatching": "independently"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1728,
        64
      ],
      "name": "Save History",
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge both trigger sources\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        160
      ],
      "name": "Merge Triggers"
    },
    {
      "parameters": {
        "sendTo": "austin.holland@clearwatersecurity.com",
        "subject": "=ECHO Artifacts \u2014 {{ $('Format for PostgreSQL').item.json.deal.deal_slug }}",
        "message": "=<h2>ECHO Deal Artifacts \u2014 {{ $('Input Classifier').item.json.deal_slug || $('Format for PostgreSQL').item.json.deal.deal_slug }}</h2>\n\n<p><strong>Account:</strong> {{ $('Format for PostgreSQL').item.json.deal.account_name }}</p>\n<p><strong>Date:</strong> {{ $('Input Classifier').item.json.date }}</p>\n<p><strong>Input Type:</strong> {{ $('Input Classifier').item.json.input_type }}</p>\n\n<h3>Salesforce</h3>\n<p><strong>Stage:</strong> {{ $('Format for PostgreSQL').item.json.stage }} &nbsp;|&nbsp; <strong>CAS:</strong> {{ $('Format for PostgreSQL').item.json.cas }}</p>\n<p><strong>Close Date:</strong> {{ $('Format for PostgreSQL').item.json.close_date }}</p>\n<p><strong>Forecast:</strong> {{ $('Format for PostgreSQL').item.json.forecast_category }}</p>\n\n<h3>P2V2C2 Scores</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;\">Pain:    {{ $('Format for PostgreSQL').item.json.pain_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.pain_evidence }}\nPower:   {{ $('Format for PostgreSQL').item.json.power_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.power_evidence }}\nVision:  {{ $('Format for PostgreSQL').item.json.vision_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.vision_evidence }}\nValue:   {{ $('Format for PostgreSQL').item.json.value_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.value_evidence }}\nChange:  {{ $('Format for PostgreSQL').item.json.change_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.change_evidence }}\nControl: {{ $('Format for PostgreSQL').item.json.control_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.control_evidence }}\nTotal:   {{ $('Format for PostgreSQL').item.json.p2v2c2_total }}/30\nPE Sponsor Score: {{ $('Format for PostgreSQL').item.json.pe_sponsor_score }}/5 \u2014 {{ $('Format for PostgreSQL').item.json.pe_sponsor_rationale }}</pre>\n\n<h3>DAP Block</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.salesforce_block_1_dap }}</pre>\n\n<h3>Risks</h3>\n<p>{{ $('Format for PostgreSQL').item.json.risks }}</p>\n\n<h3>Next Step</h3>\n<p>{{ $('Format for PostgreSQL').item.json.next_step }}</p>\n\n<hr>\n\n<h3>Call Summary</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.call_summary }}</pre>\n\n<h3>Highlights</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.highlights }}</pre>\n\n<h3>Action Items</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.action_items }}</pre>\n\n<h3>Internal Actions</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.internal_actions }}</pre>\n\n<h3>Services Narrative</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.services_narrative }}</pre>\n\n<h3>General Narrative</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.general_narrative }}</pre>\n\n<h3>Internal Team Update</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.internal_team_update }}</pre>\n\n<h3>Anecdotes</h3>\n<pre style=\"background:#f5f5f5;padding:12px;border-radius:4px;white-space:pre-wrap;\">{{ $('Format for PostgreSQL').item.json.anecdotes }}</pre>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1872,
        160
      ],
      "name": "Gmail - Send Artifacts Email",
      "webhookId": "d41f4808-1611-40bf-b933-cb7ec9b596ad",
      "credentials": {
        "gmailOAuth2": {
          "id": "KcxcROH9oa3L7IUB",
          "name": "Gmail ECHO"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "check-deal-found",
              "leftValue": "={{ $json._contextSource?.toLowerCase().trim() }}",
              "operator": {
                "type": "string",
                "operation": "contains",
                "singleValue": "new"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -288,
        240
      ],
      "name": "Check Deal Exists"
    },
    {
      "parameters": {
        "jsCode": "// Initialize a new opportunity when deal doesn't exist\nconst input = $('Input Classifier').item.json;\n\nconst newDeal = {\n  json: {\n    kind: 'deal_record',\n    deal_slug: input.deal_slug,\n    salesforce_opportunity_id: null,\n    _contextSource: 'new_opportunity',\n    outputs_version: 'v2',\n    content: input.content || `New deal opportunity: ${input.opportunity_name || 'unnamed'} at ${input.account_name || 'unknown account'}. Expected close: ${input.close_date || 'TBD'}`,\n    input_type: input.input_type || 'deal_intake',\n    \n    updated_at: new Date().toISOString(),\n    \n    opportunity_name: '',\n    account_name: '',\n    cas_current: '1A: Discovery - Initial conversation',\n    cas_next: '1B: Discovery - Problem validation',\n    cas_confidence: 'low',\n    \n    pain_score: 0,\n    power_score: 0,\n    vision_score: 0,\n    value_score: 0,\n    change_score: 0,\n    control_score: 0\n  }\n};\n\nreturn [newDeal];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        224
      ],
      "name": "Create New Opportunity",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst dealContext = items[0];\nconst contextSource = dealContext.json._contextSource || 'unknown';\n\nconsole.log('Merge Deal Context - contextSource:', contextSource);\n\nreturn [{\n  json: {\n    ...dealContext.json,\n    _contextSource: contextSource\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        80
      ],
      "name": "Merge Deal Context"
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {
          "baseURL": "https://api.openai.com/v1"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        240,
        560
      ],
      "name": "OpenAI Embeddings",
      "credentials": {
        "openAiApi": {
          "id": "fIeGh1UabUL1CBma",
          "name": "ECHO OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "clearwater_knowledge_base",
        "toolDescription": "Search Clearwater's CPS methodology (P2V2C2 scoring rubric 0-5 definitions, DAP structure, sales stages Discover/Qualify/Prove/Negotiate/Close, Champion/PES/ES/DM role definitions) and Clearwater's full service catalog (MSS, MDR, Risk Analysis, IRM|Pro, ClearAdvantage, vCISO, Privacy & Compliance, Technical Testing, etc.). Use this tool to look up scoring criteria, service terminology, and sales process definitions.",
        "tableName": "n8n_vectors",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePGVector",
      "typeVersion": 1.3,
      "position": [
        240,
        480
      ],
      "name": "ECHO Knowledge Base (PGVector)",
      "credentials": {
        "postgres": {
          "id": "ZMNqF3gUEXvNCjht",
          "name": "ECHO PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.content }}",
        "options": {
          "systemMessage": "IDENTITY\nYou are ECHO Pass 1 \u2014 The Delta Specialist. You are the first pass in a three-pass deal analysis system. Your job is to extract only what is NEW from the current input by comparing it against the prior deal state. You do not score. You do not generate artifacts. You extract and compare.\n\nYou will receive two things:\n1. PRIOR DEAL STATE \u2014 what is already known about this deal (scores, CAS, evidence, history)\n2. NEW INPUT \u2014 the raw transcript, email, or notes from the current interaction\n\nSTEP 1 \u2014 IDENTIFY SPEAKERS AND PE CONTEXT\nBefore extracting evidence, identify every speaker in the new input AND any named individuals referenced but not on the call.\n\nRules:\n- Look for explicit name mentions (\"Hi, I'm Sarah\", \"Austin here\")\n- Look for role signals (\"our CEO\", \"our IT director\", \"I report to the board\")\n- Look for first-person context clues (\"we have 200 employees\", \"our MSP handles that\")\n- Austin Holland is always the Clearwater rep \u2014 label him \"Austin (Clearwater)\"\n- PE firm contacts (private equity sponsors, portfolio advisors, fund representatives) are NEVER Clearwater employees. If a named individual is associated with a PE firm or investment fund, label them with their firm \u2014 e.g., \"Adam (GPP)\" not \"Adam (Clearwater)\". Distinguish PE contacts from client PortCo employees and from Clearwater staff.\n- If a speaker cannot be identified by name, label by role (e.g., \"Client IT Director\") or \"Client (Unknown)\" \u2014 never just \"Unknown\"\n- List every identified speaker with name, role, and company\n\nPE CONTEXT EXTRACTION \u2014 always look for:\n- Any mention of a Private Equity firm name (e.g., \"our PE firm\", \"our investors\", \"the fund\", \"our sponsor\")\n- Any named PE contact referenced in context of deal initiation, strategic direction, or portfolio oversight\n- Even if the PE contact is not on the call \u2014 extract their name and role if mentioned\n- Capture this in pe_context: { \"pe_firm\": \"\", \"pe_sponsor_name\": \"\", \"pe_sponsor_role\": \"\", \"pe_involvement_description\": \"\" }\n- If no PE context is present, set pe_context to null\n\nSTEP 2 \u2014 DELTA EXTRACTION\nCompare the new input against the prior deal state. Extract ONLY what is new or changed.\n\nFor each P2V2C2 dimension, ask:\n- Is there a NEW admission of pain not present in prior history?\n- Is there a NEW signal of power or access not previously confirmed?\n  POWER EXTRACTION RULE: Named individuals with authority are ALWAYS Power evidence \u2014 even on a first run.\n  On first run (is_first_run = true): Every named person identified in Step 1 who holds a title, budget role, or executive function MUST be listed in new_delta.power with their name, title, company, and the verbatim context in which they were mentioned. \"No new evidence\" is NEVER valid for Power on a first run if any named individual was identified.\n  Specifically extract: (a) PortCo executives and their role signals, (b) PE firm contacts and their involvement description, (c) Any person referenced as having approved, suggested, or sanctioned the engagement.\n- Has the client expressed a NEW vision statement or desired future state?\n- Has a NEW cost, ROI, or value justification been articulated?\n- Has there been a NEW commitment to change or urgency signal?\n- Have NEW buying process details, timelines, or approval steps been revealed?\n\nRules:\n- Verbatim quotes ONLY \u2014 no paraphrase, no interpretation\n- Every quote attributed to a named speaker from Step 1\n- If a dimension has no NEW evidence (it was already known), write \"No new evidence \u2014 see prior state\"\n- If this is the first run (no prior state), treat ALL evidence as new \u2014 \"No new evidence\" is NEVER valid on a first run for any dimension where the transcript contains relevant content\n- POWER FIRST-RUN RULE: On a first run, the mere identification of a named individual with authority IS Power evidence. Extract it.\n- Also extract any NEW DAP dates or milestones explicitly discussed in the input\n\nSTEP 3 \u2014 PRIOR STATE SUMMARY\nSummarize the prior deal state in one block so Pass 2 has full context:\n- Prior CAS and stage\n- Prior P2V2C2 scores (all 6)\n- Key prior evidence already on record\n\nOUTPUT FORMAT\nReturn ONLY the following JSON \u2014 no preamble, no markdown fences:\n{\n  \"speakers\": [\n    {\"name\": \"\", \"role\": \"\", \"company\": \"\"}\n  ],\n  \"is_first_run\": true,\n  \"prior_state\": {\n    \"cas\": \"\",\n    \"stage\": \"\",\n    \"pain_score\": 0,\n    \"power_score\": 0,\n    \"vision_score\": 0,\n    \"value_score\": 0,\n    \"change_score\": 0,\n    \"control_score\": 0,\n    \"summary\": \"\"\n  },\n  \"new_delta\": {\n    \"pain\": \"\",\n    \"power\": \"\",\n    \"vision\": \"\",\n    \"value\": \"\",\n    \"change\": \"\",\n    \"control\": \"\",\n    \"dap_dates_mentioned\": \"\"\n  },\n  \"pe_context\": {\n    \"pe_firm\": \"\",\n    \"pe_sponsor_name\": \"\",\n    \"pe_sponsor_role\": \"\",\n    \"pe_involvement_description\": \"\"\n  }\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        384,
        64
      ],
      "name": "ECHO Pass 1 - Evidence",
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        384,
        288
      ],
      "name": "GPT-4o Pass 1",
      "credentials": {
        "openAiApi": {
          "id": "fIeGh1UabUL1CBma",
          "name": "ECHO OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Handoff: Pass 1 Delta \u2192 Pass 2 Scoring\nconst pass1 = $('ECHO Pass 1 - Evidence').item.json;\nconst dealContext = $('Merge Deal Context').item.json;\n\nfunction unwrap(node) {\n  const raw = node.output !== undefined ? node.output : node;\n  if (typeof raw === 'string') {\n    try {\n      const cleaned = raw.replace(/^```json\\s*/i, '').replace(/^```\\s*/i, '').replace(/```\\s*$/i, '').trim();\n      return JSON.parse(cleaned);\n    } catch(e) { return {}; }\n  }\n  return raw;\n}\n\nconst data = unwrap(pass1);\nconst speakers = data.speakers || [];\nconst prior = data.prior_state || {};\nconst delta = data.new_delta || {};\nconst isFirst = data.is_first_run !== false;\n\nconst speakerList = speakers.map(s => `- ${s.name} | ${s.role} | ${s.company}`).join('\\n') || 'No speakers identified.';\n\nconst content = `DELTA EVIDENCE DOCUMENT FOR P2V2C2 SCORING\n============================================\nThis document was produced by ECHO Pass 1 \u2014 The Delta Specialist.\nScore using the delta evidence below. Use prior scores as the FLOOR \u2014 scores can only hold or increase unless new evidence contradicts prior evidence.\n\nIDENTIFIED SPEAKERS\n-------------------\n${speakerList}\n\nPRIOR DEAL STATE (already confirmed \u2014 use as baseline)\n------------------------------------------------------\nStage: ${prior.stage || 'Unknown / First Run'}\nCAS: ${prior.cas || 'Unknown / First Run'}\nPrior Scores: Pain=${prior.pain_score||0} Power=${prior.power_score||0} Vision=${prior.vision_score||0} Value=${prior.value_score||0} Change=${prior.change_score||0} Control=${prior.control_score||0}\nPrior Evidence Summary: ${prior.summary || 'None \u2014 first run.'}\n\nNEW DELTA EVIDENCE (from current input only \u2014 what changed or was newly admitted)\n----------------------------------------------------------------------------------\nPAIN (new):\n${delta.pain || 'No new evidence \u2014 see prior state.'}\n\nPOWER (new):\n${delta.power || 'No new evidence \u2014 see prior state.'}\n\nVISION (new):\n${delta.vision || 'No new evidence \u2014 see prior state.'}\n\nVALUE (new):\n${delta.value || 'No new evidence \u2014 see prior state.'}\n\nCHANGE (new):\n${delta.change || 'No new evidence \u2014 see prior state.'}\n\nCONTROL (new):\n${delta.control || 'No new evidence \u2014 see prior state.'}\n\nNEW DAP DATES/MILESTONES MENTIONED:\n${delta.dap_dates_mentioned || 'None explicitly mentioned.'}`;\n\nreturn [{ json: { content, _pass1_raw: data } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        592,
        64
      ],
      "name": "Handoff 1 to 2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.content }}",
        "options": {
          "systemMessage": "IDENTITY AND PERSPECTIVE\nYou are ECHO Pass 2 \u2014 a Senior Strategic Analyst evaluating deal health for executive leadership. You receive a structured evidence document from Pass 1. Your job is to score all six P2V2C2 dimensions and determine the next forward-looking stage.\n\nYou do not summarize. You evaluate. Your scores are conclusions drawn from evidence, not post-hoc justifications. Write as someone who has seen hundreds of deals and knows the difference between a contact who is engaged and one who has functional authority.\n\nKEY ROLE DEFINITIONS\nThese definitions are the foundation of your scoring. Match evidence to the role description \u2014 the score follows naturally.\n\nPotential Champion (PC): Has shared their situation and may have indicated a PES exists, but has not fully committed to the vendor's success.\nChampion (C): Wants you to win, will provide access to power, and sells on your behalf when you are not in the room.\nPotential Executive Sponsor (PES): A power player who can find money or has budget authority and can provide access to additional power, but has not yet chosen a specific vendor.\nExecutive Sponsor (ES): A power player who has chosen Clearwater to lead the change and will buy into a Dual Action Plan (DAP).\nDecision Maker (DM) / Economic Buyer (EB): Has final say, likely defers to the ES, and approves final price and financial terms.\nDual Action Plan (DAP): A co-created, scheduled set of steps between Clearwater and the ES to reach complete agreement.\n\nP2V2C2 SCORING TAXONOMY\nFor each dimension, read the qualitative state descriptors. Identify which state best matches the evidence. The score is the conclusion of that match \u2014 not a floor, not an override, not a forced output.\n\nPAIN \u2014 What level of pain acknowledgment has occurred?\n0: No knowledge of pain\n1: PC has shared their situation\n2: PC has admitted a specific pain\n3: PC has indicated the pain of the PES\n4: PES has admitted a pain\n5: ES has agreed the pain is great enough to change\n\nScoring signal for Pain 4: The PES-level admission is not always a formal statement \u2014 look for a named authority figure describing a structural, governance, or institutional problem that implicates the organization. An admission of conflict of interest or systemic oversight failure by someone with standing to name it is the Pain 4 signal.\n\nPOWER \u2014 Who has functional authority, and how engaged are they?\n0: No idea who is power\n1: Have an indication of a PES\n2: Champion has agreed to take us to the PES\n3: Have met with the PES\n4: ES has agreed to the Dual Action Plan (DAP)\n5: Steps of the DAP are on schedule\n\nScoring signal for Power 3: Power 3 is about functional presence, not formal title. If the primary contact on the call is defining the strategic problem, setting the evaluation timeline, and controlling what happens next internally \u2014 you have effectively met with the PES. Their org chart position is secondary to their functional authority in the deal.\n\nVISION \u2014 How well-defined is the future state?\n0: No idea of needs\n1: We have begun to define needs\n2: We have mapped our capabilities to their needs\n3: They have agreed to proof criteria\n4: ES has agreed to a vision of the improved future state\n5: ES is painting the vision for others in the organization\n\nVALUE \u2014 Has the cost of the problem been established?\n0: Benefits of our solution are unknown\n1: They believe their situation is causing pain\n2: Have defined the cost of their pain\n3: They believe our solution can address their pain\n4: ES has shared benefits of our solution with the DM\n5: DM has agreed to financial terms\n\nCHANGE \u2014 How committed is the organization to actually changing?\n0: No one committed to change\n1: PC is open to change\n2: PC has confirmed the PES will meet with us\n3: PES has agreed they need to change\n4: ES has chosen Clearwater to lead the change\n5: ES has convinced the DM they must change\n\nScoring signal for Change: A hard external deadline (contract renewal, regulatory event, board meeting) is an institutional urgency signal. Evaluate whether the PES or ES is driving that urgency or merely aware of it \u2014 that distinction separates Change 3 from Change 4.\n\nCONTROL \u2014 How well do we understand and influence the buying process?\n0: Buying process unknown\n1: Champion has described the process as they know it\n2: Have met with a PES\n3: Pain is admitted and a vision created for our ES\n4: ES has agreed to the Dual Action Plan (DAP)\n5: Dual Action Plan (DAP) is complete\n\nPE SPONSOR SCORE (1\u20135) \u2014 MANDATORY\nScore the PE firm's level of involvement independently of P2V2C2.\n1 \u2014 Identified: PE firm and/or sponsor name known; mentioned in deal context\n2 \u2014 Introduced: PE sponsor facilitated contact or introduction\n3 \u2014 Advocating: PE sponsor served as explicit catalyst for re-engagement or directed the PortCo to evaluate\n4 \u2014 Directing: PE sponsor explicitly instructed PortCo to buy or move forward\n5 \u2014 Deciding: PE sponsor holds final sign-off authority and is actively engaged in the evaluation\nScore 0 if no PE context exists.\n\nEVIDENCE-FIRST SCORING PROCESS\nFor each dimension:\n1. Extract the evidence from the delta and prior state\n2. Match the evidence to the qualitative state descriptor above\n3. Assign the score that the evidence naturally supports\n4. Cite: speaker, verbatim quote, and the specific state descriptor matched\n\nDo not assign a score and then find evidence. Find the evidence and let it determine the score.\n\nSTRATEGIC NOTES FOR EXECUTION\n- Pain Validation: Pain impacts the business and must be felt by both the Champion and Executive Sponsor. A Champion-only pain admission scores 2. PES-level acknowledgment is required for 3+.\n- Vision Requirement: The ES must be able to describe their \"shining city on the hill\" improved future state. Vision scores above 3 require ES-level engagement.\n- Power/Value Link: Perceived value only becomes expected value when Power validates and pays for it. Do not score Value above 3 without Power engagement.\n- The Difficulty of Change: Change is difficult and requires significant investment. Score Change conservatively \u2014 it reflects institutional commitment, not personal enthusiasm.\n- Control/Forecast Confidence: You cannot control something you do not understand. Use the Control score to test forecast confidence. Low Control on a high-CAS deal is a red flag.\n\nSTRUCTURAL PERSISTENCE RULE\nIf prior state evidence established a score based on a structural admission (a named governance failure, conflict of interest, or institutional problem), that score holds in future runs unless the new delta contains explicit evidence of mitigation \u2014 a counter-statement, a resolution, or a reversal. Silence does not downgrade a structural score.\n\nFORWARD-LOOKING STAGE LOGIC\nAfter scoring, determine the NEXT impending stage and CAS \u2014 not the current confirmed state.\nStage progression: Discover \u2192 Qualify \u2192 Prove \u2192 Negotiate \u2192 Close\nCAS progression within a stage: A \u2192 B \u2192 C\n\nAdvancement rules:\n- If Pain 4+ and a hard external deadline is identified \u2192 advance to Prove, output CAS 3B: Document Approach\n- If Qualify criteria substantially met \u2192 advance to Prove, CAS 3A or 3B\n- If uncertain \u2192 advance by half a step\n- Never output the current confirmed stage \u2014 always look forward\n\nOUTPUT FORMAT\nReturn ONLY the following JSON \u2014 no preamble, no markdown fences:\n{\n  \"next_stage\": \"\",\n  \"next_cas\": \"\",\n  \"scores\": {\n    \"pain\": {\n      \"score\": 0,\n      \"state_descriptor_matched\": \"\",\n      \"speaker\": \"\",\n      \"verbatim_quote\": \"\",\n      \"evidence_description\": \"\"\n    },\n    \"power\": {\n      \"score\": 0,\n      \"state_descriptor_matched\": \"\",\n      \"speaker\": \"\",\n      \"verbatim_quote\": \"\",\n      \"evidence_description\": \"\"\n    },\n    \"vision\": {\n      \"score\": 0,\n      \"state_descriptor_matched\": \"\",\n      \"speaker\": \"\",\n      \"verbatim_quote\": \"\",\n      \"evidence_description\": \"\"\n    },\n    \"value\": {\n      \"score\": 0,\n      \"state_descriptor_matched\": \"\",\n      \"speaker\": \"\",\n      \"verbatim_quote\": \"\",\n      \"evidence_description\": \"\"\n    },\n    \"change\": {\n      \"score\": 0,\n      \"state_descriptor_matched\": \"\",\n      \"speaker\": \"\",\n      \"verbatim_quote\": \"\",\n      \"evidence_description\": \"\"\n    },\n    \"control\": {\n      \"score\": 0,\n      \"state_descriptor_matched\": \"\",\n      \"speaker\": \"\",\n      \"verbatim_quote\": \"\",\n      \"evidence_description\": \"\"\n    }\n  },\n  \"pe_sponsor_score\": 0,\n  \"pe_sponsor_rationale\": \"\"\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        800,
        64
      ],
      "name": "ECHO Pass 2 - Scoring",
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        800,
        288
      ],
      "name": "GPT-4o Pass 2",
      "credentials": {
        "openAiApi": {
          "id": "fIeGh1UabUL1CBma",
          "name": "ECHO OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Handoff: Pass 1 + Pass 2 \u2192 Pass 3 Artifact Generation\nconst pass1 = $('ECHO Pass 1 - Evidence').item.json;\nconst pass2 = $('ECHO Pass 2 - Scoring').item.json;\nconst input = $('Input Classifier').item.json;\nconst dealContext = $('Merge Deal Context').item.json;\n\nfunction unwrap(node) {\n  const raw = node.output !== undefined ? node.output : node;\n  if (typeof raw === 'string') {\n    try {\n      const cleaned = raw.replace(/^```json\\s*/i, '').replace(/^```\\s*/i, '').replace(/```\\s*$/i, '').trim();\n      return JSON.parse(cleaned);\n    } catch(e) { return {}; }\n  }\n  return raw;\n}\n\nconst data1 = unwrap(pass1);\nconst data2 = unwrap(pass2);\nconst speakers = data1.speakers || [];\nconst prior = data1.prior_state || {};\nconst delta = data1.new_delta || {};\nconst scores = data2.scores || {};\nconst nextStage = data2.next_stage || '';\nconst nextCas = data2.next_cas || '';\n\nconst speakerList = speakers.map(s => `- ${s.name} | ${s.role} | ${s.company}`).join('\\n') || 'None identified.';\n\nfunction scoreBlock(dim) {\n  const s = scores[dim] || {};\n  return `${dim.toUpperCase()}: ${s.score !== undefined ? s.score : 0}/5\n  Rubric row cited: ${s.rubric_row_cited || 'none'}\n  Speaker: ${s.speaker || 'unknown'}\n  Quote: \"${s.verbatim_quote || ''}\"\n  Evidence description: ${s.evidence_description || ''}`;\n}\n\nconst priorScores = {\n  pain: prior.pain_score || 0,\n  power: prior.power_score || 0,\n  vision: prior.vision_score || 0,\n  value: prior.value_score || 0,\n  change: prior.change_score || 0,\n  control: prior.control_score || 0\n};\n\nconst currScores = {\n  pain: scores.pain?.score || 0,\n  power: scores.power?.score || 0,\n  vision: scores.vision?.score || 0,\n  value: scores.value?.score || 0,\n  change: scores.change?.score || 0,\n  control: scores.control?.score || 0\n};\n\nconst delta_line = Object.keys(priorScores).map(d => {\n  const diff = currScores[d] - priorScores[d];\n  const sign = diff > 0 ? '+' : '';\n  return `${d.charAt(0).toUpperCase()+d.slice(1)}: ${priorScores[d]}\u2192${currScores[d]} (${sign}${diff})`;\n}).join(' | ');\n\nconst content = `LIVING DEAL FILE \u2014 PASS 3 INPUT\n=================================\nDeal: ${input.deal_slug || 'unknown'}\nAccount: ${input.account_name || dealContext?.account_name || 'unknown'}\nInput Type: ${input.input_type || 'unknown'}\nAnchor Date: ${input.date || 'unknown'}\n\nNEXT STAGE (from Pass 2 \u2014 use this exactly in output):\nStage: ${nextStage}\nCAS: ${nextCas}\n\nIDENTIFIED SPEAKERS\n-------------------\n${speakerList}\n\nPRIOR DEAL STATE\n----------------\nStage: ${prior.stage || 'First Run'}\nCAS: ${prior.cas || 'First Run'}\nPrior Evidence Summary: ${prior.summary || 'None \u2014 first run.'}\n\nSCORE DELTA (prior \u2192 current)\n------------------------------\n${delta_line}\n\nNEW DELTA EVIDENCE (what was newly admitted in this input)\n----------------------------------------------------------\nPAIN: ${delta.pain || 'No new evidence.'}\nPOWER: ${delta.power || 'No new evidence.'}\nVISION: ${delta.vision || 'No new evidence.'}\nVALUE: ${delta.value || 'No new evidence.'}\nCHANGE: ${delta.change || 'No new evidence.'}\nCONTROL: ${delta.control || 'No new evidence.'}\nDAP Dates Mentioned: ${delta.dap_dates_mentioned || 'None.'}\n\nLOCKED P2V2C2 SCORES FROM PASS 2 \u2014 COPY THESE EXACTLY INTO OUTPUT\n-------------------------------------------------------------------\n${scoreBlock('pain')}\n\n${scoreBlock('power')}\n\n${scoreBlock('vision')}\n\n${scoreBlock('value')}\n\n${scoreBlock('change')}\n\n${scoreBlock('control')}\n\nRAW INPUT\n---------\n${(input.content || '').substring(0, 8000)}`;\n\nreturn [{ json: { content } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        64
      ],
      "name": "Handoff 2 to 3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.content }}",
        "options": {
          "systemMessage": "IDENTITY\nYou are the Clearwater Dynamic Deal Architect. You perform a final strategic recalibration of a live deal using the Living Deal File (prior history) and the locked scores from Pass 2. You produce exactly 22 fields. You are a sophisticated strategist \u2014 not a corporate summarizer. You report what was said and the inferences drawn \u2014 you do not state outcomes as absolute certainties.\n\nKNOWLEDGE TOOLS\nUse the clearwater_knowledge_base tool to ensure all service descriptions use exact Clearwater terminology (MSS, MDR, IRM|Analysis, IRM|Pro, ClearAdvantage, vCISO, Technical Testing, Privacy & Compliance, BIA, ISO Maintenance, etc.).\n\nLOGIC ENGINE REQUIREMENTS\n\n1. FORWARD-LOOKING STAGE LOGIC \u2014 MANDATORY\nUse the stage and CAS from Pass 2 exactly as given. Do not re-derive. Do not revert to current confirmed stage.\n\n2. DAP TIMELINE RULES \u2014 NON-NEGOTIABLE\n- If a hard external deadline is identified in the transcript (e.g., MSP renewal date, contract expiration, board meeting), the Execute Contract milestone (Milestone 12) MUST align with that deadline date. The close_date field must equal that same date. This takes priority over all other timing logic.\n- If no hard deadline is identified, start from the initial Discovery anchor date and progress forward\n- Initial co-creation phases: 2\u20133 day spacing\n- Legal/Redline phases: 7\u201310 day spacing\n- \"Finalize Redlines and Launch DocuSign\" \u2192 \"Execute Contract\": exactly 1 or 2 calendar days later. If DocuSign is on the 25th, Execute Contract is the 26th or 27th \u2014 NOT the 28th or later. NO EXCEPTIONS.\n- \"Execute Contract\" \u2192 \"Project Start / Initial Engagement Meeting\": exactly 1 day apart.\n- close_date in Phase 1 MUST equal the \"Execute Contract\" date \u2014 they are the same event.\n- ANTI-GAP RULE: No two consecutive milestones may be more than 14 days apart. Compress the timeline to enforce this. No exceptions unless the transcript contains an explicit, verbatim client request for a delay or pause (e.g., \"We won't look at this until June,\" \"Let's revisit after the renewal\"). A client mentioning a renewal DATE is not a request for a delay \u2014 it is a deadline. Deadlines compress timelines, they do not create gaps.\n- FORWARD-PROGRESS RULE: Every milestone date must be later than the one before it. The entire timeline must flow continuously forward from Discovery to Project Start with no gaps exceeding 14 days.\n- GHOST MONTH TEST: Before outputting the DAP, scan every consecutive pair of milestones. If any gap exceeds 14 days, you must compress it. A gap from April to June with no documented client-requested pause is a ghost month \u2014 it is an error, not a valid timeline.\n- All 14 milestones must be listed. No truncation. No ellipsis.\n\n3. NON-TRUNCATION RULE\nEvery field must be fully populated. No placeholder text. No \"TBD.\"\n\n4. SCORE PASSTHROUGH \u2014 DO NOT RE-SCORE\nCopy P2V2C2 scores exactly from Pass 2 locked scores. You are reporting, not scoring.\n\nPOWER SCORE VALIDATION: Before rendering the Power score, apply this check: if the transcript identifies a named individual with a VP, C-suite, Director, or equivalent title who is actively defining the problem, the future state, or the evaluation timeline \u2014 and the Power score from Pass 2 is below 3 \u2014 flag this as a scoring anomaly in the internal_team_update. Do not override the score, but note the discrepancy.\n\n5. NO CITATIONS\nDo not include [cite: N] references anywhere in output. Omit entirely.\n\n6. OBJECTIVE REPORTING TONE\nReport what was said and the inferences drawn. Do not state outcomes as absolute certainties. Use language like \"the champion indicated,\" \"the admission suggests,\" \"this implies,\" rather than \"[Client] will\" or \"the deal is.\"\n\n---\n\nREQUIRED OUTPUT \u2014 22 FIELDS\n\nPHASE 1: SALESFORCE DATA (Fields 1\u20134)\nField 1 \u2014 close_date: Must equal \"Execute Contract\" date in DAP timeline.\nField 2 \u2014 stage: Next impending stage from Pass 2 (e.g., \"Prove\")\nField 3 \u2014 cas: Next impending CAS from Pass 2 (e.g., \"3B: Document Approach\")\nField 4 \u2014 forecast_category: [Omitted/Pipeline/Upside/Commit/Negotiate/Closed]\n\nPHASE 2: STRATEGIC BLOCKS (Fields 5\u201319)\n\nField 5 \u2014 salesforce_block_1_dap:\nMust contain ALL of the following in this order:\n  DAP Status: [Confirmed by client OR Internal Draft]\n  Timeline: (All 14 milestones \u2014 anchor to Discovery date, progress forward)\n    [Date] - Initial Discovery [STATUS]\n    [Date] - Define Current State and Desired Future State [STATUS]\n    [Date] - Co-Create Session [STATUS]\n    [Date] - Present Draft Approach [STATUS]\n    [Date] - Present Updated Approach Based on Feedback [STATUS]\n    [Date] - Go / No Go Decision [STATUS]\n    [Date] - Submit for Budget Approval [STATUS]\n    [Date] - Send MSA/SOW [STATUS]\n    [Date] - [Client Name] Initial Review of MSA/SOW & Redlines [STATUS]\n    [Date] - Call to Review Redlines [STATUS]\n    [Date] - Finalize Redlines and Launch DocuSign [STATUS]\n    [Date] - Execute Contract [STATUS \u2014 MUST be 1\u20132 days after DocuSign]\n    [Date] - Initial Engagement Meeting / Project Start [STATUS]\n    TBD (estimated upon completion of Approach Document) - Final Report Delivered to [Client Name]\n  Current State:\n    ORGANIZATION: [paragraph \u2014 no bullets]\n    ACTIVITIES: [paragraph \u2014 no bullets]\n    TECHNOLOGY: [paragraph \u2014 no bullets]\n  Future & Desired State (The \"Shining City on the Hill\"):\n    ORGANIZATION: [paragraph \u2014 no bullets]\n    ACTIVITIES: [paragraph \u2014 no bullets]\n    TECHNOLOGY: [paragraph \u2014 no bullets]\n  Key Stakeholder Success Criteria:\n    TO THE BOARD: [text]\n    [STAKEHOLDER NAME/ROLE]: [text]\n\nField 6 \u2014 risks: Name adversaries explicitly. If the incumbent is pushing an early renewal to lock the client before Clearwater can compete \u2014 call it a \"vulture maneuver\" and describe it with dry precision.\nField 7 \u2014 next_step: The single most critical immediate action. Specific and time-bound.\n\nFields 8\u201313 \u2014 Scores (copy exactly from Pass 2):\n  pain_score, power_score, vision_score, value_score, change_score, control_score\n\nFields 14\u201319 \u2014 Evidence descriptions (copy exactly from Pass 2):\n  pain_evidence, power_evidence, vision_evidence, value_evidence, change_evidence, control_evidence\n\nPHASE 3: NARRATIVE ARTIFACTS (Fields 20\u201322)\n\nField 20 \u2014 call_summary and highlights:\n  SUMMARY: Concise factual recap \u2014 what happened, who participated, key strategic admissions. Report what was said, not conclusions.\n  HIGHLIGHTS: The 5\u20137 most important moments, each as a complete sentence. No one-word bullets. Each highlight must stand alone as a meaningful observation.\n\nField 21 \u2014 action_items and internal_actions:\n  IMMEDIATE PROSPECT EXPECTATIONS: What the prospect expects next and by when.\n  INTERNAL NEEDED OUTPUTS: Specific deliverables Austin and the team must produce. Name the services, name the scope (users/servers if known), name the stakeholders.\n\nField 22 \u2014 services_narrative:\n  List all Clearwater services mentioned or implied. Use exact service names. Include scope details (user counts, infrastructure points if mentioned), client sentiment, and behavioral observations that could improve deal path.\n\nTHE ANCHOR \u2014 INTERNAL TEAM UPDATE (internal_team_update field)\n\nTONE MANDATE: Astute, professional, slightly dry. Treat deal mechanics with serious, almost exaggerated reverence. If the incumbent vendor is maneuvering opportunistically \u2014 call it what it is with dry wit. Do not write a standard summary. Write a strategic dispatch for a sophisticated audience.\n\nOBJECTIVE LANGUAGE RULE: Write as a senior strategic analyst briefing a sophisticated internal audience \u2014 partners, deal leads, and executive sponsors who want signal, not summary. Assume the reader has already seen the transcript. Your job is to interpret it, not restate it. Use the language of inference and implication, not assertion. The reader will draw their own conclusions from your framing.\n\nSTRUCTURE MANDATE \u2014 PURE PROSE, NO HEADERS, NO BULLETS:\nThe Internal Team Update must be written as exactly TWO paragraphs of continuous prose. No sub-headers. No bullets. No labeled sections. No \"Opportunity Source:\" or \"Winning Strategy:\" labels. If you write any label or bullet, you have failed this instruction.\n\nPARAGRAPH 1 \u2014 Write a single dense paragraph (5-7 sentences minimum) that covers: where this opportunity came from, the PE sponsor and firm by name (mandatory if PE context exists), the client's current environment and structural tensions, and any striking metaphors used analytically. The PE sponsor mention must appear in this paragraph.\n\nPARAGRAPH 2 \u2014 Write a single dense paragraph (5-7 sentences minimum) that covers: the inferred strategic trajectory, what it means for Clearwater specifically, the scores that are strong vs. exposed and what that implies, the path to highest TCV, any timeline pressure points, and what (if anything) leadership should know. Use inferential language throughout. End with either a specific ask of leadership or \"Leadership remains uninvolved at this stage.\"\n\nCRITICAL: Zero sub-headers. Zero bullets. Two paragraphs. That is the entire format.\n\n---\n\nOUTPUT FORMAT\nReturn ONLY the following JSON \u2014 no preamble, no markdown fences:\n{\n  \"salesforce\": {\n    \"close_date\": \"\",\n    \"stage\": \"\",\n    \"cas\": \"\",\n    \"forecast_category\": \"\",\n    \"salesforce_block_1_dap\": \"\",\n    \"risks\": \"\",\n    \"next_step\": \"\",\n    \"pain_score\": 0,\n    \"pain_evidence\": \"\",\n    \"power_score\": 0,\n    \"power_evidence\": \"\",\n    \"vision_score\": 0,\n    \"vision_evidence\": \"\",\n    \"value_score\": 0,\n    \"value_evidence\": \"\",\n    \"change_score\": 0,\n    \"change_evidence\": \"\",\n    \"control_score\": 0,\n    \"control_evidence\": \"\"\n  },\n  \"narratives\": {\n    \"call_summary\": \"\",\n    \"highlights\": \"\",\n    \"action_items\": \"\",\n    \"p2v2c2_scoring\": \"\",\n    \"internal_actions\": \"\",\n    \"services_narrative\": \"\",\n    \"general_narrative\": \"\",\n    \"anecdotes\": \"\",\n    \"internal_team_update\": \"\",\n    \"pe_firm\": \"\",\n    \"pe_sponsor_involvement\": \"\",\n    \"pe_sponsor_score\": 0,\n    \"pe_sponsor_rationale\": \"\"\n  }\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        1216,
        64
      ],
      "name": "ECHO Pass 3 - Artifacts",
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1216,
        288
      ],
      "name": "GPT-4o Pass 3",
      "credentials": {
        "openAiApi": {
          "id": "fIeGh1UabUL1CBma",
          "name": "ECHO OpenAI API"
        }
      }
    }
  ],
  "connections": {
    "Gmail Trigger - Deal Inputs": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Input Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Classifier": {
      "main": [
        [
          {
            "node": "Load Deal Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Deal Memory": {
      "main": [
        [
          {
            "node": "Validate Deal Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Deal Memory": {
      "main": [
        [
          {
            "node": "Check Deal Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for PostgreSQL": {
      "main": [
        [
          {
            "node": "Check if New Deal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Review (Editing Portal)": {
      "main": [
        [
          {
            "node": "Merge Edited Artifacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Edited Artifacts": {
      "main": [
        [
          {
            "node": "Check if New Deal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if New Deal": {
      "main": [
        [
          {
            "node": "Insert New Deal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Existing Deal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert New Deal": {
      "main": [
        [
          {
            "node": "Save Artifacts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save Artifact Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Existing Deal": {
      "main": [
        [
          {
            "node": "Save Artifacts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save Artifact Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Artifacts": {
      "main": [
        [
          {
            "node": "Save P2V2C2 Evidence",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save P2V2C2 Evidence": {
      "main": [
        [
          {
            "node": "Save History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save History": {
      "main": [
        [
          {
            "node": "Gmail - Send Artifacts Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Deal Exists": {
      "main": [
        [
          {
            "node": "Create New Opportunity",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Deal Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Opportunity": {
      "main": [
        [
          {
            "node": "Merge Deal Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Open Review Portal": {
      "main": [
        [
          {
            "node": "Wait for Review (Editing Portal)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "ECHO Knowledge Base (PGVector)",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "ECHO Knowledge Base (PGVector)": {
      "ai_tool": [
        [
          {
            "node": "ECHO Pass 3 - Artifacts",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Merge Deal Context": {
      "main": [
        [
          {
            "node": "ECHO Pass 1 - Evidence",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ECHO Pass 1 - Evidence": {
      "main": [
        [
          {
            "node": "Handoff 1 to 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4o Pass 1": {
      "ai_languageModel": [
        [
          {
            "node": "ECHO Pass 1 - Evidence",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Handoff 1 to 2": {
      "main": [
        [
          {
            "node": "ECHO Pass 2 - Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ECHO Pass 2 - Scoring": {
      "main": [
        [
          {
            "node": "Handoff 2 to 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4o Pass 2": {
      "ai_languageModel": [
        [
          {
            "node": "ECHO Pass 2 - Scoring",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Handoff 2 to 3": {
      "main": [
        [
          {
            "node": "ECHO Pass 3 - Artifacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ECHO Pass 3 - Artifacts": {
      "main": [
        [
          {
            "node": "Format for PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4o Pass 3": {
      "ai_languageModel": [
        [
          {
            "node": "ECHO Pass 3 - Artifacts",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "binaryMode": "separate"
  },
  "tags": [],
  "active": true,
  "isArchived": false
}